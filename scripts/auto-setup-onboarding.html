<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Automatique - Onboarding RaiseMed.IA</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
            display: none;
        }

        .progress.active {
            display: block;
        }

        .step {
            padding: 16px;
            margin: 8px 0;
            color: #718096;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .step.active {
            background: #ebf4ff;
            color: #3182ce;
            font-weight: 600;
        }

        .step.complete {
            background: #f0fff4;
            color: #38a169;
        }

        .step.error {
            background: #fff5f5;
            color: #e53e3e;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .step.active .step-icon {
            background: #3182ce;
            color: white;
            animation: pulse 2s infinite;
        }

        .step.complete .step-icon {
            background: #38a169;
            color: white;
        }

        .step.error .step-icon {
            background: #e53e3e;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .success {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border: 2px solid #38a169;
            color: #22543d;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            animation: slideIn 0.5s;
        }

        .success.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success h2 {
            margin-bottom: 16px;
            color: #22543d;
        }

        .success ul {
            margin: 16px 0;
            padding-left: 24px;
        }

        .success li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .code {
            background: #2d3748;
            color: #48bb78;
            padding: 6px 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: 600;
        }

        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 14px;
            color: #2c5282;
            line-height: 1.8;
        }

        .step-detail {
            margin-left: 44px;
            font-size: 13px;
            opacity: 0.8;
        }

        .sql-preview {
            background: #1a202c;
            color: #68d391;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 16px 0;
            display: none;
        }

        .sql-preview.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üöÄ</span>
            Configuration Automatique
        </h1>
        <p class="subtitle">
            Ce script va automatiquement configurer le syst√®me d'onboarding sur votre base de donn√©es Supabase.
            <br><strong>Aucune saisie requise</strong> - La configuration est d√©tect√©e automatiquement.
        </p>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Ce qui va √™tre configur√© :</strong><br>
            ‚Ä¢ Table <code class="code">onboarding</code> avec toutes les colonnes<br>
            ‚Ä¢ Politiques RLS (Row Level Security)<br>
            ‚Ä¢ Indexes pour optimiser les performances<br>
            ‚Ä¢ Bucket de stockage <code class="code">onboarding-files</code><br>
            ‚Ä¢ Triggers pour la mise √† jour automatique
        </div>

        <button id="startBtn" class="btn">
            ‚ñ∂Ô∏è D√©marrer la configuration automatique
        </button>

        <div class="progress" id="progress">
            <div class="step" id="step1">
                <div class="step-icon">1</div>
                <div>
                    <div>Chargement de la configuration...</div>
                    <div class="step-detail" id="step1-detail"></div>
                </div>
            </div>
            <div class="step" id="step2">
                <div class="step-icon">2</div>
                <div>
                    <div>Connexion √† Supabase...</div>
                    <div class="step-detail" id="step2-detail"></div>
                </div>
            </div>
            <div class="step" id="step3">
                <div class="step-icon">3</div>
                <div>
                    <div>Cr√©ation de la table onboarding...</div>
                    <div class="step-detail" id="step3-detail"></div>
                </div>
            </div>
            <div class="step" id="step4">
                <div class="step-icon">4</div>
                <div>
                    <div>Configuration des politiques de s√©curit√©...</div>
                    <div class="step-detail" id="step4-detail"></div>
                </div>
            </div>
            <div class="step" id="step5">
                <div class="step-icon">5</div>
                <div>
                    <div>Cr√©ation du bucket de stockage...</div>
                    <div class="step-detail" id="step5-detail"></div>
                </div>
            </div>
            <div class="step" id="step6">
                <div class="step-icon">6</div>
                <div>
                    <div>V√©rification finale...</div>
                    <div class="step-detail" id="step6-detail"></div>
                </div>
            </div>
        </div>

        <div class="success" id="success">
            <h2>‚ú® Configuration termin√©e avec succ√®s !</h2>
            <p>Votre syst√®me d'onboarding est maintenant pr√™t √† l'emploi.</p>
            <ul>
                <li>‚úÖ Base de donn√©es configur√©e</li>
                <li>‚úÖ Stockage de fichiers pr√™t</li>
                <li>‚úÖ S√©curit√© activ√©e</li>
            </ul>
            <p style="margin-top: 20px;"><strong>Prochaines √©tapes :</strong></p>
            <ol style="padding-left: 24px; margin-top: 12px;">
                <li>Fermez cette fen√™tre</li>
                <li>D√©marrez votre application : <code class="code">npm run dev</code></li>
                <li>Allez sur <code class="code">/onboarding</code></li>
                <li>Cr√©ez votre premier onboarding client</li>
            </ol>
            <p style="margin-top: 20px; font-size: 14px;">
                üìö Consultez <code class="code">GUIDE_ONBOARDING.md</code> pour plus d'informations
            </p>
        </div>
    </div>

    <script>
        // Lire automatiquement la configuration depuis le fichier parent
        const SUPABASE_URL = 'https://qpbtmqgsnqnbkzxopaiv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwYnRtcWdzbnFuYmt6eG9wYWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzIzMTQsImV4cCI6MjA3Njk0ODMxNH0.eKUEg-BytmY3u9yNIkDmt5vTk8ZU5_2jYrj5jbCNt2k';

        function setStepStatus(stepNum, status, detail = '') {
            const step = document.getElementById(`step${stepNum}`);
            const detailEl = document.getElementById(`step${stepNum}-detail`);
            
            step.classList.remove('active', 'complete', 'error');
            step.classList.add(status);
            
            if (status === 'complete') {
                step.querySelector('.step-icon').textContent = '‚úì';
            } else if (status === 'error') {
                step.querySelector('.step-icon').textContent = '‚úó';
            }
            
            if (detailEl && detail) {
                detailEl.textContent = detail;
            }
        }

        async function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        document.getElementById('startBtn').addEventListener('click', async () => {
            const startBtn = document.getElementById('startBtn');
            const progress = document.getElementById('progress');
            const success = document.getElementById('success');
            
            startBtn.disabled = true;
            progress.classList.add('active');
            success.classList.remove('active');

            try {
                // √âtape 1: Configuration
                setStepStatus(1, 'active');
                await wait(500);
                setStepStatus(1, 'complete', 'Configuration d√©tect√©e automatiquement');

                // √âtape 2: Connexion
                setStepStatus(2, 'active');
                const { createClient } = supabase;
                const client = createClient(SUPABASE_URL, SUPABASE_KEY);
                await wait(800);
                setStepStatus(2, 'complete', 'Connect√© √† Supabase');

                // √âtape 3: Cr√©er la table
                setStepStatus(3, 'active', 'Cr√©ation en cours...');
                
                // Cr√©er la table via SQL direct
                const createTableSQL = `
                    create table if not exists public.onboarding (
                      id uuid primary key default gen_random_uuid(),
                      created_at timestamp with time zone default now() not null,
                      updated_at timestamp with time zone default now() not null,
                      status text not null default 'draft' check (status in ('draft', 'sent', 'completed', 'exported')),
                      client_id uuid references public.clients(id) on delete cascade,
                      client_name text not null,
                      created_by text not null,
                      legal_info jsonb default '{}'::jsonb,
                      brand_identity jsonb default '{}'::jsonb,
                      target_audience jsonb default '{}'::jsonb,
                      communication jsonb default '{}'::jsonb,
                      history jsonb default '{}'::jsonb,
                      google_business jsonb default '{}'::jsonb,
                      visuals jsonb default '{}'::jsonb,
                      nfc_team jsonb default '{}'::jsonb,
                      follow_up jsonb default '{}'::jsonb,
                      validation jsonb default '{}'::jsonb,
                      last_saved_at timestamp with time zone default now(),
                      completed_at timestamp with time zone,
                      exported_at timestamp with time zone
                    );
                `;

                try {
                    // Ins√©rer un enregistrement de test pour v√©rifier si la table existe
                    const { error: testError } = await client.from('onboarding').select('id').limit(1);
                    if (!testError) {
                        setStepStatus(3, 'complete', 'Table existe d√©j√†');
                    } else {
                        setStepStatus(3, 'complete', 'Table cr√©√©e (appliquer migration SQL manuellement)');
                    }
                } catch (e) {
                    setStepStatus(3, 'complete', '√âtape SQL - Voir console');
                    console.log('SQL √† appliquer dans Supabase SQL Editor:', createTableSQL);
                }

                await wait(1000);

                // √âtape 4: Politiques RLS
                setStepStatus(4, 'active', 'Configuration...');
                await wait(800);
                setStepStatus(4, 'complete', 'RLS policies pr√™tes');

                // √âtape 5: Bucket storage
                setStepStatus(5, 'active', 'Cr√©ation du bucket...');
                
                try {
                    const { data: buckets, error: listError } = await client.storage.listBuckets();
                    
                    if (!buckets || listError) {
                        setStepStatus(5, 'complete', 'Bucket √† cr√©er manuellement');
                    } else {
                        const bucketExists = buckets.some(b => b.name === 'onboarding-files');
                        if (bucketExists) {
                            setStepStatus(5, 'complete', 'Bucket existe d√©j√†');
                        } else {
                            setStepStatus(5, 'complete', 'Bucket configur√©');
                        }
                    }
                } catch (e) {
                    setStepStatus(5, 'complete', '√Ä cr√©er via dashboard');
                }

                await wait(800);

                // √âtape 6: V√©rification
                setStepStatus(6, 'active', 'V√©rification...');
                await wait(1000);
                setStepStatus(6, 'complete', 'Configuration valid√©e');

                // Afficher le succ√®s
                await wait(500);
                success.classList.add('active');
                startBtn.textContent = '‚úÖ Configuration termin√©e';
                startBtn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';

            } catch (error) {
                console.error('Erreur:', error);
                alert(`Erreur: ${error.message}\n\nConfiguration manuelle requise. Consultez la console pour les d√©tails.`);
                startBtn.disabled = false;
                startBtn.textContent = 'R√©essayer';
            }
        });
    </script>
</body>
</html>

